{"ast":null,"code":"import _objectSpread from\"C:\\\\Users\\\\pccis\\\\Desktop\\\\amturk-client\\\\node_modules\\\\react-scripts\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"C:\\\\Users\\\\pccis\\\\Desktop\\\\amturk-client\\\\node_modules\\\\react-scripts\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"C:\\\\Users\\\\pccis\\\\Desktop\\\\amturk-client\\\\node_modules\\\\react-scripts\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import React,{useRef,useState,useLayoutEffect,useEffect,useMemo}from\"react\";import{Matrix}from\"transformation-matrix-js\";import{makeStyles}from\"@material-ui/core/styles\";import styles from\"./styles_ImageCanvas\";import useMouse from\"./useMouse\";import useProjectRegionBox from\"./useProjectBox\";import{useRafState}from\"react-use\";import RegionTags from\"../RegionTags/main_RegionTags\";import RegionSelectAndTransformBoxes from\"../TransformBoxes/main_TransformBoxes\";import ImageCanvasBackground from\"./background\";import useEventCallback from\"use-event-callback\";import RegionShapes from\"../RegionShapes/main_RegionShapes\";// get style from style.js\nvar myStyle=makeStyles(styles);var getCanvasDimension=function getCanvasDimension(){var allowedArea=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},iw=_ref.iw,ih=_ref.ih;var dimension=Matrix.from(1,0,0,1,-10,-10);if(allowedArea&&iw){dimension=dimension.translate(allowedArea.x*iw,allowedArea.y*ih).scaleU(allowedArea.w+0.05);}return dimension;};export var ImageCanvas=function ImageCanvas(_ref2){var regions=_ref2.regions,imageSrc=_ref2.imageSrc,_ref2$onMouseMove=_ref2.onMouseMove,onMouseMove=_ref2$onMouseMove===void 0?function(p){return null;}:_ref2$onMouseMove,_ref2$onMouseDown=_ref2.onMouseDown,onMouseDown=_ref2$onMouseDown===void 0?function(p){return null;}:_ref2$onMouseDown,_ref2$onMouseUp=_ref2.onMouseUp,onMouseUp=_ref2$onMouseUp===void 0?function(p){return null;}:_ref2$onMouseUp,_ref2$dragWithPrimary=_ref2.dragWithPrimary,dragWithPrimary=_ref2$dragWithPrimary===void 0?false:_ref2$dragWithPrimary,_ref2$zoomWithPrimary=_ref2.zoomWithPrimary,zoomWithPrimary=_ref2$zoomWithPrimary===void 0?false:_ref2$zoomWithPrimary,_ref2$createWithPrima=_ref2.createWithPrimary,createWithPrimary=_ref2$createWithPrima===void 0?false:_ref2$createWithPrima,regionTagList=_ref2.regionTagList,allowedArea=_ref2.allowedArea,onLoaded=_ref2.onLoaded,onChangeRegion=_ref2.onChangeRegion,onBeginRegionEdit=_ref2.onBeginRegionEdit,onCloseRegionEdit=_ref2.onCloseRegionEdit,onBeginBoxTransform=_ref2.onBeginBoxTransform,onBeginMovePolygonPoint=_ref2.onBeginMovePolygonPoint,onAddPolygonPoint=_ref2.onAddPolygonPoint,onBeginMovePolygon1Point=_ref2.onBeginMovePolygon1Point,onAddPolygon1Point=_ref2.onAddPolygon1Point,onBeginMoveKeypoint=_ref2.onBeginMoveKeypoint,onSelectRegion=_ref2.onSelectRegion,onBeginMovePoint=_ref2.onBeginMovePoint,onDeleteRegion=_ref2.onDeleteRegion,onRegionClassAdded=_ref2.onRegionClassAdded,_ref2$zoomOnAllowedAr=_ref2.zoomOnAllowedArea,zoomOnAllowedArea=_ref2$zoomOnAllowedAr===void 0?true:_ref2$zoomOnAllowedAr,allowComments=_ref2.allowComments,nBeginCircleTransform=_ref2.nBeginCircleTransform;var classes=myStyle();var canvasEl=useRef(null);var layoutParams=useRef({});var _useRafState=useRafState(false),_useRafState2=_slicedToArray(_useRafState,2),dragging=_useRafState2[0],changeDragging=_useRafState2[1];var _useRafState3=useRafState(null),_useRafState4=_slicedToArray(_useRafState3,2),zoomStart=_useRafState4[0],changeZoomStart=_useRafState4[1];var _useRafState5=useRafState(null),_useRafState6=_slicedToArray(_useRafState5,2),zoomEnd=_useRafState6[0],changeZoomEnd=_useRafState6[1];var _useRafState7=useRafState(getCanvasDimension()),_useRafState8=_slicedToArray(_useRafState7,2),mat=_useRafState8[0],changeMat=_useRafState8[1];var _useMouse=useMouse({canvasEl:canvasEl,dragging:dragging,mat:mat,layoutParams:layoutParams,changeMat:changeMat,zoomStart:zoomStart,zoomEnd:zoomEnd,changeZoomStart:changeZoomStart,changeZoomEnd:changeZoomEnd,changeDragging:changeDragging,zoomWithPrimary:zoomWithPrimary,dragWithPrimary:dragWithPrimary,onMouseMove:onMouseMove,onMouseDown:onMouseDown,onMouseUp:onMouseUp}),mouseEvents=_useMouse.mouseEvents,mousePosition=_useMouse.mousePosition;var projectRegionBox=useProjectRegionBox({layoutParams:layoutParams,mat:mat});var _useState=useState(),_useState2=_slicedToArray(_useState,2),imageDimensions=_useState2[0],changeImageDimensions=_useState2[1];var imageLoaded=Boolean(imageDimensions&&imageDimensions.naturalWidth);var ImageLoaded=useEventCallback(function(_ref3){var naturalWidth=_ref3.naturalWidth,naturalHeight=_ref3.naturalHeight;var dims={naturalWidth:naturalWidth,naturalHeight:naturalHeight};if(onLoaded)onLoaded(dims);changeImageDimensions(dims);});var canvas=canvasEl.current;if(canvas&&imageLoaded){var clientWidth=canvas.clientWidth,clientHeight=canvas.clientHeight;var fitScale=Math.max(imageDimensions.naturalWidth/(clientWidth-20),imageDimensions.naturalHeight/(clientHeight-20));var _iw=imageDimensions.naturalWidth/fitScale,_ih=imageDimensions.naturalHeight/fitScale;layoutParams.current={iw:_iw,ih:_ih,fitScale:fitScale,canvasWidth:clientWidth,canvasHeight:clientHeight};}useEffect(function(){if(!imageLoaded)return;changeMat(getCanvasDimension(zoomOnAllowedArea?allowedArea:null,layoutParams.current));},[imageLoaded]);useLayoutEffect(function(){if(!imageDimensions)return;var clientWidth=canvas.clientWidth,clientHeight=canvas.clientHeight;canvas.width=clientWidth;canvas.height=clientHeight;var context=canvas.getContext(\"2d\");context.save();context.transform.apply(context,_toConsumableArray(mat.clone().inverse().toArray()));var _layoutParams$current=layoutParams.current,iw=_layoutParams$current.iw,ih=_layoutParams$current.ih;if(allowedArea){// Pattern to indicate the NOT allowed areas\nvar x=allowedArea.x,y=allowedArea.y,w=allowedArea.w,h=allowedArea.h;context.save();context.globalAlpha=1;var outer=[[0,0],[iw,0],[iw,ih],[0,ih]];var inner=[[x*iw,y*ih],[x*iw+w*iw,y*ih],[x*iw+w*iw,y*ih+h*ih],[x*iw,y*ih+h*ih]];context.moveTo.apply(context,_toConsumableArray(outer[0]));outer.forEach(function(p){return context.lineTo.apply(context,_toConsumableArray(p));});context.lineTo.apply(context,_toConsumableArray(outer[0]));context.closePath();inner.reverse();context.moveTo.apply(context,_toConsumableArray(inner[0]));inner.forEach(function(p){return context.lineTo.apply(context,_toConsumableArray(p));});context.lineTo.apply(context,_toConsumableArray(inner[0]));context.fill();context.restore();}context.restore();});var _layoutParams$current2=layoutParams.current,iw=_layoutParams$current2.iw,ih=_layoutParams$current2.ih;var zoomBox=!zoomStart||!zoomEnd?null:_objectSpread(_objectSpread({},mat.clone().inverse().applyToPoint(zoomStart.x,zoomStart.y)),{},{w:(zoomEnd.x-zoomStart.x)/mat.a,h:(zoomEnd.y-zoomStart.y)/mat.d});if(zoomBox){if(zoomBox.w<0){zoomBox.x+=zoomBox.w;zoomBox.w*=-1;}if(zoomBox.h<0){zoomBox.y+=zoomBox.h;zoomBox.h*=-1;}}var imagePosition={topLeft:mat.clone().inverse().applyToPoint(0,0),bottomRight:mat.clone().inverse().applyToPoint(iw,ih)};return/*#__PURE__*/React.createElement(\"div\",{style:{width:\"100%\",height:\"100%\",maxHeight:\"calc(100vh - 68px)\",position:\"relative\",overflow:\"hidden\",cursor:createWithPrimary?\"crosshair\":dragging?\"grabbing\":dragWithPrimary?\"grab\":zoomWithPrimary?mat.a<1?\"zoom-out\":\"zoom-in\":undefined}},imageLoaded&&!dragging&&/*#__PURE__*/React.createElement(RegionSelectAndTransformBoxes,{key:\"regionSelectAndTransformBoxes\",regions:!allowedArea?regions:[{type:\"rectangle\",id:\"$$allowed_area\",cls:\"allowed_area\",highlighted:true,x:allowedArea.x,y:allowedArea.y,w:allowedArea.w,h:allowedArea.h,visible:true,color:\"#ff0\"}],mouseEvents:mouseEvents,projectRegionBox:projectRegionBox,dragWithPrimary:dragWithPrimary,createWithPrimary:createWithPrimary,zoomWithPrimary:zoomWithPrimary,onBeginMovePoint:onBeginMovePoint,onSelectRegion:onSelectRegion,layoutParams:layoutParams,mat:mat,onBeginBoxTransform:onBeginBoxTransform,onBeginMovePolygonPoint:onBeginMovePolygonPoint,onBeginMoveKeypoint:onBeginMoveKeypoint,onAddPolygonPoint:onAddPolygonPoint,onAddPolygon1Point:onAddPolygon1Point,onBeginMovePolygon1Point:onBeginMovePolygon1Point}),imageLoaded&&!dragging&&/*#__PURE__*/React.createElement(\"div\",{key:\"regionTags\"},/*#__PURE__*/React.createElement(RegionTags,{regions:regions,projectRegionBox:projectRegionBox,mouseEvents:mouseEvents,regionTagList:regionTagList,onBeginRegionEdit:onBeginRegionEdit,onChangeRegion:onChangeRegion,onCloseRegionEdit:onCloseRegionEdit,onDeleteRegion:onDeleteRegion,layoutParams:layoutParams,imageSrc:imageSrc,onRegionClassAdded:onRegionClassAdded,allowComments:allowComments})),zoomWithPrimary&&zoomBox!==null&&/*#__PURE__*/React.createElement(\"div\",{key:\"zoomBox\",style:{position:\"absolute\",zIndex:1,border:\"1px solid #fff\",pointerEvents:\"none\",left:zoomBox.x,top:zoomBox.y,width:zoomBox.w,height:zoomBox.h}}),/*#__PURE__*/React.createElement(\"div\",Object.assign({style:{width:\"100%\",height:\"100%\"}},mouseEvents),/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"canvas\",{style:{opacity:0.25},className:classes.canvas,ref:canvasEl}),/*#__PURE__*/React.createElement(RegionShapes,{imagePosition:imagePosition,regions:regions}),/*#__PURE__*/React.createElement(ImageCanvasBackground,{imagePosition:imagePosition,mouseEvents:mouseEvents,onLoad:ImageLoaded,imageSrc:imageSrc}))),/*#__PURE__*/React.createElement(\"div\",{className:classes.zoomIndicator},(1/mat.a*100).toFixed(0),\"%\"));};export default ImageCanvas;","map":{"version":3,"sources":["C:/Users/pccis/Desktop/amturk-client/src/pages/Home/annotateComponents/ImageCanvas/main_ImageCanvas.js"],"names":["React","useRef","useState","useLayoutEffect","useEffect","useMemo","Matrix","makeStyles","styles","useMouse","useProjectRegionBox","useRafState","RegionTags","RegionSelectAndTransformBoxes","ImageCanvasBackground","useEventCallback","RegionShapes","myStyle","getCanvasDimension","allowedArea","iw","ih","dimension","from","translate","x","y","scaleU","w","ImageCanvas","regions","imageSrc","onMouseMove","p","onMouseDown","onMouseUp","dragWithPrimary","zoomWithPrimary","createWithPrimary","regionTagList","onLoaded","onChangeRegion","onBeginRegionEdit","onCloseRegionEdit","onBeginBoxTransform","onBeginMovePolygonPoint","onAddPolygonPoint","onBeginMovePolygon1Point","onAddPolygon1Point","onBeginMoveKeypoint","onSelectRegion","onBeginMovePoint","onDeleteRegion","onRegionClassAdded","zoomOnAllowedArea","allowComments","nBeginCircleTransform","classes","canvasEl","layoutParams","dragging","changeDragging","zoomStart","changeZoomStart","zoomEnd","changeZoomEnd","mat","changeMat","mouseEvents","mousePosition","projectRegionBox","imageDimensions","changeImageDimensions","imageLoaded","Boolean","naturalWidth","ImageLoaded","naturalHeight","dims","canvas","current","clientWidth","clientHeight","fitScale","Math","max","canvasWidth","canvasHeight","width","height","context","getContext","save","transform","clone","inverse","toArray","h","globalAlpha","outer","inner","moveTo","forEach","lineTo","closePath","reverse","fill","restore","zoomBox","applyToPoint","a","d","imagePosition","topLeft","bottomRight","maxHeight","position","overflow","cursor","undefined","type","id","cls","highlighted","visible","color","zIndex","border","pointerEvents","left","top","opacity","zoomIndicator","toFixed"],"mappings":"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","sourcesContent":["import React, {\n  useRef,\n  useState,\n  useLayoutEffect,\n  useEffect,\n  useMemo,\n} from \"react\"\nimport { Matrix } from \"transformation-matrix-js\"\nimport type {\n  Region,\n  Point,\n  Polygon,\n  Polygon1,\n  Rectangle,\n  Circle\n} from \"./regionTools.js\"\nimport { makeStyles } from \"@material-ui/core/styles\"\nimport styles from \"./styles_ImageCanvas\"\nimport useMouse from \"./useMouse\"\nimport useProjectRegionBox from \"./useProjectBox\"\nimport { useRafState } from \"react-use\"\nimport RegionTags from \"../RegionTags/main_RegionTags\"\nimport RegionSelectAndTransformBoxes from \"../TransformBoxes/main_TransformBoxes\"\nimport ImageCanvasBackground from \"./background\"\nimport useEventCallback from \"use-event-callback\"\nimport RegionShapes from \"../RegionShapes/main_RegionShapes\"\n\n// get style from style.js\nconst myStyle = makeStyles(styles)\n\ntype Props = {\n  regions: Array<Region>,\n  imageSrc?: string,\n  onMouseMove?: ({ x: number, y: number }) => any,\n  onMouseDown?: ({ x: number, y: number }) => any,\n  onMouseUp?: ({ x: number, y: number }) => any,\n  dragWithPrimary?: boolean,\n  zoomWithPrimary?: boolean,\n  createWithPrimary?: boolean,\n  realSize?: { width: number, height: number, unitName: string },\n  regionTagList?: Array<string>,\n  allowedArea?: { x: number, y: number, w: number, h: number },\n  allowComments?: Boolean,\n  onChangeRegion: (Region) => any,\n  onBeginRegionEdit: (Region) => any,\n  onCloseRegionEdit: (Region) => any,\n  onDeleteRegion: (Region) => any,\n  onBeginBoxTransform: (Rectangle, [number, number]) => any,\n  onBeginMovePolygonPoint: (Polygon, index: number) => any,\n  onAddPolygonPoint: (Polygon, point: [number, number], index: number) => any,\n  onBeginMovePolygon1Point: (Polygon1, index1: number) => any,\n  onAddPolygon1Point: (Polygon1, Polygon1Index:number, point1: [number, number], index1: number) => any,\n  onBeginCircleTransform: (Circle, directions: string) => any,\n  onSelectRegion: (Region) => any,\n  onBeginMovePoint: (Point) => any,\n  onLoaded: ({\n    naturalWidth: number,\n    naturalHeight: number,\n  }) => any,\n  onRegionClassAdded: () => {},\n}\nconst getCanvasDimension = (allowedArea = null, { iw, ih } = {}) => {\n  let dimension = Matrix.from(1, 0, 0, 1, -10, -10)\n  if (allowedArea && iw) {\n    dimension = dimension\n      .translate(allowedArea.x * iw, allowedArea.y * ih)\n      .scaleU(allowedArea.w + 0.05)\n  }\n  return dimension\n}\n\nexport const ImageCanvas = ({\n  regions,\n  imageSrc,\n  onMouseMove = (p) => null,\n  onMouseDown = (p) => null,\n  onMouseUp = (p) => null,\n  dragWithPrimary = false,\n  zoomWithPrimary = false,\n  createWithPrimary = false,\n  regionTagList,\n  allowedArea,\n  onLoaded,\n  onChangeRegion,\n  onBeginRegionEdit,\n  onCloseRegionEdit,\n  onBeginBoxTransform,\n  onBeginMovePolygonPoint,\n  onAddPolygonPoint,\n  onBeginMovePolygon1Point,\n  onAddPolygon1Point,\n  onBeginMoveKeypoint,\n  onSelectRegion,\n  onBeginMovePoint,\n  onDeleteRegion,\n  onRegionClassAdded,\n  zoomOnAllowedArea = true,\n  allowComments,\nnBeginCircleTransform,\n}: Props) => {\n  const classes = myStyle()\n\n  const canvasEl = useRef(null)\n  const layoutParams = useRef({})\n  const [dragging, changeDragging] = useRafState(false)\n  const [zoomStart, changeZoomStart] = useRafState(null)\n  const [zoomEnd, changeZoomEnd] = useRafState(null)\n  const [mat, changeMat] = useRafState(getCanvasDimension())\n\n  const { mouseEvents, mousePosition } = useMouse({\n    canvasEl,\n    dragging,\n    mat,\n    layoutParams,\n    changeMat,\n    zoomStart,\n    zoomEnd,\n    changeZoomStart,\n    changeZoomEnd,\n    changeDragging,\n    zoomWithPrimary,\n    dragWithPrimary,\n    onMouseMove,\n    onMouseDown,\n    onMouseUp,\n  })\n\n\n\n  const projectRegionBox = useProjectRegionBox({ layoutParams, mat })\n\n  const [imageDimensions, changeImageDimensions] = useState()\n  const imageLoaded = Boolean(imageDimensions && imageDimensions.naturalWidth)\n\n  const ImageLoaded = useEventCallback(\n    ({ naturalWidth, naturalHeight}) => {\n      const dims = { naturalWidth, naturalHeight}\n      if (onLoaded) onLoaded(dims)\n      changeImageDimensions(dims)\n\n    }\n  )\n  const canvas = canvasEl.current\n  if (canvas && imageLoaded) {\n    const { clientWidth, clientHeight } = canvas\n\n    const fitScale = Math.max(\n      imageDimensions.naturalWidth / (clientWidth - 20),\n      imageDimensions.naturalHeight / (clientHeight - 20)\n    )\n\n    const [iw, ih] = [\n      imageDimensions.naturalWidth / fitScale,\n      imageDimensions.naturalHeight / fitScale,\n    ]\n\n    layoutParams.current = {\n      iw,\n      ih,\n      fitScale,\n      canvasWidth: clientWidth,\n      canvasHeight: clientHeight,\n    }\n  }\n\n  useEffect(() => {\n    if (!imageLoaded) return\n    changeMat(\n        getCanvasDimension(\n        zoomOnAllowedArea ? allowedArea : null,\n        layoutParams.current\n      )\n    )\n  }, [imageLoaded])\n\n  useLayoutEffect(() => {\n    if (!imageDimensions) return\n    const { clientWidth, clientHeight } = canvas\n    canvas.width = clientWidth\n    canvas.height = clientHeight\n    const context = canvas.getContext(\"2d\")\n\n    context.save()\n    context.transform(...mat.clone().inverse().toArray())\n\n    const { iw, ih } = layoutParams.current\n\n    if (allowedArea) {\n      // Pattern to indicate the NOT allowed areas\n      const { x, y, w, h } = allowedArea\n      context.save()\n      context.globalAlpha = 1\n      const outer = [\n        [0, 0],\n        [iw, 0],\n        [iw, ih],\n        [0, ih],\n      ]\n      const inner = [\n        [x * iw, y * ih],\n        [x * iw + w * iw, y * ih],\n        [x * iw + w * iw, y * ih + h * ih],\n        [x * iw, y * ih + h * ih],\n      ]\n      context.moveTo(...outer[0])\n      outer.forEach((p) => context.lineTo(...p))\n      context.lineTo(...outer[0])\n      context.closePath()\n\n      inner.reverse()\n      context.moveTo(...inner[0])\n      inner.forEach((p) => context.lineTo(...p))\n      context.lineTo(...inner[0])\n\n      context.fill()\n\n      context.restore()\n    }\n\n    context.restore()\n  })\n\n  const { iw, ih } = layoutParams.current\n\n  let zoomBox =\n    !zoomStart || !zoomEnd\n      ? null\n      : {\n          ...mat.clone().inverse().applyToPoint(zoomStart.x, zoomStart.y),\n          w: (zoomEnd.x - zoomStart.x) / mat.a,\n          h: (zoomEnd.y - zoomStart.y) / mat.d,\n        }\n  if (zoomBox) {\n    if (zoomBox.w < 0) {\n      zoomBox.x += zoomBox.w\n      zoomBox.w *= -1\n    }\n    if (zoomBox.h < 0) {\n      zoomBox.y += zoomBox.h\n      zoomBox.h *= -1\n    }\n  }\n\n  const imagePosition = {\n    topLeft: mat.clone().inverse().applyToPoint(0, 0),\n    bottomRight: mat.clone().inverse().applyToPoint(iw, ih),\n  }\n\n\n  return (\n    <div\n      style={{\n        width: \"100%\",\n        height: \"100%\",\n        maxHeight: \"calc(100vh - 68px)\",\n        position: \"relative\",\n        overflow: \"hidden\",\n        cursor: createWithPrimary\n          ? \"crosshair\"\n          : dragging\n          ? \"grabbing\"\n          : dragWithPrimary\n          ? \"grab\"\n          : zoomWithPrimary\n          ? mat.a < 1\n            ? \"zoom-out\"\n            : \"zoom-in\"\n          : undefined,\n      }}\n    >\n      {imageLoaded && !dragging && (\n        <RegionSelectAndTransformBoxes\n          key=\"regionSelectAndTransformBoxes\"\n          regions={\n             !allowedArea\n              ? regions\n              : [\n                  {\n                    type: \"rectangle\",\n                    id: \"$$allowed_area\",\n                    cls: \"allowed_area\",\n                    highlighted: true,\n                    x: allowedArea.x,\n                    y: allowedArea.y,\n                    w: allowedArea.w,\n                    h: allowedArea.h,\n                    visible: true,\n                    color: \"#ff0\",\n                  },\n                ]\n          }\n          mouseEvents={mouseEvents}\n          projectRegionBox={projectRegionBox}\n          dragWithPrimary={dragWithPrimary}\n          createWithPrimary={createWithPrimary}\n          zoomWithPrimary={zoomWithPrimary}\n          onBeginMovePoint={onBeginMovePoint}\n          onSelectRegion={onSelectRegion}\n          layoutParams={layoutParams}\n          mat={mat}\n          onBeginBoxTransform={onBeginBoxTransform}\n          onBeginMovePolygonPoint={onBeginMovePolygonPoint}\n          onBeginMoveKeypoint={onBeginMoveKeypoint}\n          onAddPolygonPoint={onAddPolygonPoint}\n          onAddPolygon1Point={onAddPolygon1Point}\n          onBeginMovePolygon1Point={onBeginMovePolygon1Point}\n        />\n      )}\n      {imageLoaded  && !dragging && (\n        <div key=\"regionTags\">\n          <RegionTags\n            regions={regions}\n            projectRegionBox={projectRegionBox}\n            mouseEvents={mouseEvents}\n            regionTagList={regionTagList}\n            onBeginRegionEdit={onBeginRegionEdit}\n            onChangeRegion={onChangeRegion}\n            onCloseRegionEdit={onCloseRegionEdit}\n            onDeleteRegion={onDeleteRegion}\n            layoutParams={layoutParams}\n            imageSrc={imageSrc}\n            onRegionClassAdded={onRegionClassAdded}\n            allowComments={allowComments}\n          />\n       </div>\n      )}\n\n      {zoomWithPrimary && zoomBox !== null && (\n        <div\n          key=\"zoomBox\"\n          style={{\n            position: \"absolute\",\n            zIndex: 1,\n            border: \"1px solid #fff\",\n            pointerEvents: \"none\",\n            left: zoomBox.x,\n            top: zoomBox.y,\n            width: zoomBox.w,\n            height: zoomBox.h,\n          }}\n        />\n      )}\n\n      <div\n        style={{ width: \"100%\", height: \"100%\" }}\n        {...mouseEvents}\n      >\n\n        <>\n          <canvas\n            style={{ opacity: 0.25 }}\n            className={classes.canvas}\n            ref={canvasEl}\n          />\n          <RegionShapes\n            imagePosition={imagePosition}\n            regions={regions}\n          />\n          <ImageCanvasBackground\n            imagePosition={imagePosition}\n            mouseEvents={mouseEvents}\n            onLoad={ImageLoaded}\n            imageSrc={imageSrc}\n          />\n        </>\n      </div>\n      <div className={classes.zoomIndicator}>\n        {((1 / mat.a) * 100).toFixed(0)}%\n      </div>\n    </div>\n  )\n}\n\nexport default ImageCanvas\n"]},"metadata":{},"sourceType":"module"}