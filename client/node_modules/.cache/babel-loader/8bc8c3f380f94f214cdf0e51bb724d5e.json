{"ast":null,"code":"import _objectSpread from \"/Users/yan/Documents/GItHub/ML4GIS/client/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\nimport _slicedToArray from \"/Users/yan/Documents/GItHub/ML4GIS/client/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"/Users/yan/Documents/GItHub/ML4GIS/client/src/pages/Home/annotateComponents/ImageCanvas/main_ImageCanvas.js\";\nimport React, { useRef, useState, useLayoutEffect, useEffect, useMemo } from \"react\";\nimport { Matrix } from \"transformation-matrix-js\";\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport styles from \"./styles_ImageCanvas\";\nimport useMouse from \"./useMouse\";\nimport useProjectRegionBox from \"./useProjectBox\";\nimport { useRafState } from \"react-use\";\nimport RegionTags from \"../RegionTags/main_RegionTags\";\nimport RegionSelectAndTransformBoxes from \"../TransformBoxes/main_TransformBoxes\";\nimport ImageCanvasBackground from \"./background\";\nimport useEventCallback from \"use-event-callback\";\nimport RegionShapes from \"../RegionShapes/main_RegionShapes\"; // get style from style.js\n\nconst myStyle = makeStyles(styles);\n\nconst getCanvasDimension = (allowedArea = null, {\n  iw,\n  ih\n} = {}) => {\n  let dimension = Matrix.from(1, 0, 0, 1, -10, -10);\n\n  if (allowedArea && iw) {\n    dimension = dimension.translate(allowedArea.x * iw, allowedArea.y * ih).scaleU(allowedArea.w + 0.05);\n  }\n\n  return dimension;\n};\n\nexport const ImageCanvas = ({\n  regions,\n  imageSrc,\n  onMouseMove = p => null,\n  onMouseDown = p => null,\n  onMouseUp = p => null,\n  dragWithPrimary = false,\n  zoomWithPrimary = false,\n  createWithPrimary = false,\n  regionTagList,\n  allowedArea,\n  onLoaded,\n  onChangeRegion,\n  onBeginRegionEdit,\n  onCloseRegionEdit,\n  onBeginBoxTransform,\n  onBeginMovePolygonPoint,\n  onAddPolygonPoint,\n  onBeginMoveKeypoint,\n  onSelectRegion,\n  onBeginMovePoint,\n  onDeleteRegion,\n  onRegionClassAdded,\n  zoomOnAllowedArea = true,\n  allowComments\n}) => {\n  const classes = myStyle();\n  const canvasEl = useRef(null);\n  const layoutParams = useRef({});\n\n  const _useRafState = useRafState(false),\n        _useRafState2 = _slicedToArray(_useRafState, 2),\n        dragging = _useRafState2[0],\n        changeDragging = _useRafState2[1];\n\n  const _useRafState3 = useRafState(null),\n        _useRafState4 = _slicedToArray(_useRafState3, 2),\n        zoomStart = _useRafState4[0],\n        changeZoomStart = _useRafState4[1];\n\n  const _useRafState5 = useRafState(null),\n        _useRafState6 = _slicedToArray(_useRafState5, 2),\n        zoomEnd = _useRafState6[0],\n        changeZoomEnd = _useRafState6[1];\n\n  const _useRafState7 = useRafState(getCanvasDimension()),\n        _useRafState8 = _slicedToArray(_useRafState7, 2),\n        mat = _useRafState8[0],\n        changeMat = _useRafState8[1];\n\n  const _useMouse = useMouse({\n    canvasEl,\n    dragging,\n    mat,\n    layoutParams,\n    changeMat,\n    zoomStart,\n    zoomEnd,\n    changeZoomStart,\n    changeZoomEnd,\n    changeDragging,\n    zoomWithPrimary,\n    dragWithPrimary,\n    onMouseMove,\n    onMouseDown,\n    onMouseUp\n  }),\n        mouseEvents = _useMouse.mouseEvents,\n        mousePosition = _useMouse.mousePosition;\n\n  const projectRegionBox = useProjectRegionBox({\n    layoutParams,\n    mat\n  });\n\n  const _useState = useState(),\n        _useState2 = _slicedToArray(_useState, 2),\n        imageDimensions = _useState2[0],\n        changeImageDimensions = _useState2[1];\n\n  const imageLoaded = Boolean(imageDimensions && imageDimensions.naturalWidth);\n  const ImageLoaded = useEventCallback(({\n    naturalWidth,\n    naturalHeight\n  }) => {\n    const dims = {\n      naturalWidth,\n      naturalHeight\n    };\n    if (onLoaded) onLoaded(dims);\n    changeImageDimensions(dims);\n  });\n  const canvas = canvasEl.current;\n\n  if (canvas && imageLoaded) {\n    const clientWidth = canvas.clientWidth,\n          clientHeight = canvas.clientHeight;\n    const fitScale = Math.max(imageDimensions.naturalWidth / (clientWidth - 20), imageDimensions.naturalHeight / (clientHeight - 20));\n    const iw = imageDimensions.naturalWidth / fitScale,\n          ih = imageDimensions.naturalHeight / fitScale;\n    layoutParams.current = {\n      iw,\n      ih,\n      fitScale,\n      canvasWidth: clientWidth,\n      canvasHeight: clientHeight\n    };\n  }\n\n  useEffect(() => {\n    if (!imageLoaded) return;\n    changeMat(getCanvasDimension(zoomOnAllowedArea ? allowedArea : null, layoutParams.current));\n  }, [imageLoaded]);\n  useLayoutEffect(() => {\n    if (!imageDimensions) return;\n    const clientWidth = canvas.clientWidth,\n          clientHeight = canvas.clientHeight;\n    canvas.width = clientWidth;\n    canvas.height = clientHeight;\n    const context = canvas.getContext(\"2d\");\n    context.save();\n    context.transform(...mat.clone().inverse().toArray());\n    const _layoutParams$current = layoutParams.current,\n          iw = _layoutParams$current.iw,\n          ih = _layoutParams$current.ih;\n\n    if (allowedArea) {\n      // Pattern to indicate the NOT allowed areas\n      const x = allowedArea.x,\n            y = allowedArea.y,\n            w = allowedArea.w,\n            h = allowedArea.h;\n      context.save();\n      context.globalAlpha = 1;\n      const outer = [[0, 0], [iw, 0], [iw, ih], [0, ih]];\n      const inner = [[x * iw, y * ih], [x * iw + w * iw, y * ih], [x * iw + w * iw, y * ih + h * ih], [x * iw, y * ih + h * ih]];\n      context.moveTo(...outer[0]);\n      outer.forEach(p => context.lineTo(...p));\n      context.lineTo(...outer[0]);\n      context.closePath();\n      inner.reverse();\n      context.moveTo(...inner[0]);\n      inner.forEach(p => context.lineTo(...p));\n      context.lineTo(...inner[0]);\n      context.fill();\n      context.restore();\n    }\n\n    context.restore();\n  });\n  const _layoutParams$current2 = layoutParams.current,\n        iw = _layoutParams$current2.iw,\n        ih = _layoutParams$current2.ih;\n  let zoomBox = !zoomStart || !zoomEnd ? null : _objectSpread(_objectSpread({}, mat.clone().inverse().applyToPoint(zoomStart.x, zoomStart.y)), {}, {\n    w: (zoomEnd.x - zoomStart.x) / mat.a,\n    h: (zoomEnd.y - zoomStart.y) / mat.d\n  });\n\n  if (zoomBox) {\n    if (zoomBox.w < 0) {\n      zoomBox.x += zoomBox.w;\n      zoomBox.w *= -1;\n    }\n\n    if (zoomBox.h < 0) {\n      zoomBox.y += zoomBox.h;\n      zoomBox.h *= -1;\n    }\n  }\n\n  const imagePosition = {\n    topLeft: mat.clone().inverse().applyToPoint(0, 0),\n    bottomRight: mat.clone().inverse().applyToPoint(iw, ih)\n  };\n  return /*#__PURE__*/React.createElement(\"div\", {\n    style: {\n      width: \"100%\",\n      height: \"100%\",\n      maxHeight: \"calc(100vh - 68px)\",\n      position: \"relative\",\n      overflow: \"hidden\",\n      cursor: createWithPrimary ? \"crosshair\" : dragging ? \"grabbing\" : dragWithPrimary ? \"grab\" : zoomWithPrimary ? mat.a < 1 ? \"zoom-out\" : \"zoom-in\" : undefined\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 243,\n      columnNumber: 5\n    }\n  }, imageLoaded && !dragging && /*#__PURE__*/React.createElement(RegionSelectAndTransformBoxes, {\n    key: \"regionSelectAndTransformBoxes\",\n    regions: !allowedArea ? regions : [{\n      type: \"rectangle\",\n      id: \"$$allowed_area\",\n      cls: \"allowed_area\",\n      highlighted: true,\n      x: allowedArea.x,\n      y: allowedArea.y,\n      w: allowedArea.w,\n      h: allowedArea.h,\n      visible: true,\n      color: \"#ff0\"\n    }],\n    mouseEvents: mouseEvents,\n    projectRegionBox: projectRegionBox,\n    dragWithPrimary: dragWithPrimary,\n    createWithPrimary: createWithPrimary,\n    zoomWithPrimary: zoomWithPrimary,\n    onBeginMovePoint: onBeginMovePoint,\n    onSelectRegion: onSelectRegion,\n    layoutParams: layoutParams,\n    mat: mat,\n    onBeginBoxTransform: onBeginBoxTransform,\n    onBeginMovePolygonPoint: onBeginMovePolygonPoint,\n    onBeginMoveKeypoint: onBeginMoveKeypoint,\n    onAddPolygonPoint: onAddPolygonPoint,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 264,\n      columnNumber: 9\n    }\n  }), imageLoaded && !dragging && /*#__PURE__*/React.createElement(\"div\", {\n    key: \"regionTags\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 300,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(RegionTags, {\n    regions: regions,\n    projectRegionBox: projectRegionBox,\n    mouseEvents: mouseEvents,\n    regionTagList: regionTagList,\n    onBeginRegionEdit: onBeginRegionEdit,\n    onChangeRegion: onChangeRegion,\n    onCloseRegionEdit: onCloseRegionEdit,\n    onDeleteRegion: onDeleteRegion,\n    layoutParams: layoutParams,\n    imageSrc: imageSrc,\n    onRegionClassAdded: onRegionClassAdded,\n    allowComments: allowComments,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 301,\n      columnNumber: 11\n    }\n  })), zoomWithPrimary && zoomBox !== null && /*#__PURE__*/React.createElement(\"div\", {\n    key: \"zoomBox\",\n    style: {\n      position: \"absolute\",\n      zIndex: 1,\n      border: \"1px solid #fff\",\n      pointerEvents: \"none\",\n      left: zoomBox.x,\n      top: zoomBox.y,\n      width: zoomBox.w,\n      height: zoomBox.h\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 319,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(\"div\", Object.assign({\n    style: {\n      width: \"100%\",\n      height: \"100%\"\n    }\n  }, mouseEvents, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 334,\n      columnNumber: 7\n    }\n  }), /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(\"canvas\", {\n    style: {\n      opacity: 0.25\n    },\n    className: classes.canvas,\n    ref: canvasEl,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 340,\n      columnNumber: 11\n    }\n  }), /*#__PURE__*/React.createElement(RegionShapes, {\n    imagePosition: imagePosition,\n    regions: regions,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 345,\n      columnNumber: 11\n    }\n  }), /*#__PURE__*/React.createElement(ImageCanvasBackground, {\n    imagePosition: imagePosition,\n    mouseEvents: mouseEvents,\n    onLoad: ImageLoaded,\n    imageSrc: imageSrc,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 349,\n      columnNumber: 11\n    }\n  }))), /*#__PURE__*/React.createElement(\"div\", {\n    className: classes.zoomIndicator,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 357,\n      columnNumber: 7\n    }\n  }, (1 / mat.a * 100).toFixed(0), \"%\"));\n};\nexport default ImageCanvas;","map":{"version":3,"sources":["/Users/yan/Documents/GItHub/ML4GIS/client/src/pages/Home/annotateComponents/ImageCanvas/main_ImageCanvas.js"],"names":["React","useRef","useState","useLayoutEffect","useEffect","useMemo","Matrix","makeStyles","styles","useMouse","useProjectRegionBox","useRafState","RegionTags","RegionSelectAndTransformBoxes","ImageCanvasBackground","useEventCallback","RegionShapes","myStyle","getCanvasDimension","allowedArea","iw","ih","dimension","from","translate","x","y","scaleU","w","ImageCanvas","regions","imageSrc","onMouseMove","p","onMouseDown","onMouseUp","dragWithPrimary","zoomWithPrimary","createWithPrimary","regionTagList","onLoaded","onChangeRegion","onBeginRegionEdit","onCloseRegionEdit","onBeginBoxTransform","onBeginMovePolygonPoint","onAddPolygonPoint","onBeginMoveKeypoint","onSelectRegion","onBeginMovePoint","onDeleteRegion","onRegionClassAdded","zoomOnAllowedArea","allowComments","classes","canvasEl","layoutParams","dragging","changeDragging","zoomStart","changeZoomStart","zoomEnd","changeZoomEnd","mat","changeMat","mouseEvents","mousePosition","projectRegionBox","imageDimensions","changeImageDimensions","imageLoaded","Boolean","naturalWidth","ImageLoaded","naturalHeight","dims","canvas","current","clientWidth","clientHeight","fitScale","Math","max","canvasWidth","canvasHeight","width","height","context","getContext","save","transform","clone","inverse","toArray","h","globalAlpha","outer","inner","moveTo","forEach","lineTo","closePath","reverse","fill","restore","zoomBox","applyToPoint","a","d","imagePosition","topLeft","bottomRight","maxHeight","position","overflow","cursor","undefined","type","id","cls","highlighted","visible","color","zIndex","border","pointerEvents","left","top","opacity","zoomIndicator","toFixed"],"mappings":"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","sourcesContent":["import React, {\n  useRef,\n  useState,\n  useLayoutEffect,\n  useEffect,\n  useMemo,\n} from \"react\"\nimport { Matrix } from \"transformation-matrix-js\"\nimport type {\n  Region,\n  Point,\n  Polygon,\n  Rectangle,\n} from \"./regionTools.js\"\nimport { makeStyles } from \"@material-ui/core/styles\"\nimport styles from \"./styles_ImageCanvas\"\nimport useMouse from \"./useMouse\"\nimport useProjectRegionBox from \"./useProjectBox\"\nimport { useRafState } from \"react-use\"\nimport RegionTags from \"../RegionTags/main_RegionTags\"\nimport RegionSelectAndTransformBoxes from \"../TransformBoxes/main_TransformBoxes\"\nimport ImageCanvasBackground from \"./background\"\nimport useEventCallback from \"use-event-callback\"\nimport RegionShapes from \"../RegionShapes/main_RegionShapes\"\n\n// get style from style.js\nconst myStyle = makeStyles(styles)\n\ntype Props = {\n  regions: Array<Region>,\n  imageSrc?: string,\n  onMouseMove?: ({ x: number, y: number }) => any,\n  onMouseDown?: ({ x: number, y: number }) => any,\n  onMouseUp?: ({ x: number, y: number }) => any,\n  dragWithPrimary?: boolean,\n  zoomWithPrimary?: boolean,\n  createWithPrimary?: boolean,\n  realSize?: { width: number, height: number, unitName: string },\n  regionTagList?: Array<string>,\n  allowedArea?: { x: number, y: number, w: number, h: number },\n  allowComments?: Boolean,\n  onChangeRegion: (Region) => any,\n  onBeginRegionEdit: (Region) => any,\n  onCloseRegionEdit: (Region) => any,\n  onDeleteRegion: (Region) => any,\n  onBeginBoxTransform: (Rectangle, [number, number]) => any,\n  onBeginMovePolygonPoint: (Polygon, index: number) => any,\n  onAddPolygonPoint: (Polygon, point: [number, number], index: number) => any,\n  onSelectRegion: (Region) => any,\n  onBeginMovePoint: (Point) => any,\n  onLoaded: ({\n    naturalWidth: number,\n    naturalHeight: number,\n  }) => any,\n  onRegionClassAdded: () => {},\n}\nconst getCanvasDimension = (allowedArea = null, { iw, ih } = {}) => {\n  let dimension = Matrix.from(1, 0, 0, 1, -10, -10)\n  if (allowedArea && iw) {\n    dimension = dimension\n      .translate(allowedArea.x * iw, allowedArea.y * ih)\n      .scaleU(allowedArea.w + 0.05)\n  }\n  return dimension\n}\n\nexport const ImageCanvas = ({\n  regions,\n  imageSrc,\n  onMouseMove = (p) => null,\n  onMouseDown = (p) => null,\n  onMouseUp = (p) => null,\n  dragWithPrimary = false,\n  zoomWithPrimary = false,\n  createWithPrimary = false,\n  regionTagList,\n  allowedArea,\n  onLoaded,\n  onChangeRegion,\n  onBeginRegionEdit,\n  onCloseRegionEdit,\n  onBeginBoxTransform,\n  onBeginMovePolygonPoint,\n  onAddPolygonPoint,\n  onBeginMoveKeypoint,\n  onSelectRegion,\n  onBeginMovePoint,\n  onDeleteRegion,\n  onRegionClassAdded,\n  zoomOnAllowedArea = true,\n  allowComments,\n}: Props) => {\n  const classes = myStyle()\n\n  const canvasEl = useRef(null)\n  const layoutParams = useRef({})\n  const [dragging, changeDragging] = useRafState(false)\n  const [zoomStart, changeZoomStart] = useRafState(null)\n  const [zoomEnd, changeZoomEnd] = useRafState(null)\n  const [mat, changeMat] = useRafState(getCanvasDimension())\n\n  const { mouseEvents, mousePosition } = useMouse({\n    canvasEl,\n    dragging,\n    mat,\n    layoutParams,\n    changeMat,\n    zoomStart,\n    zoomEnd,\n    changeZoomStart,\n    changeZoomEnd,\n    changeDragging,\n    zoomWithPrimary,\n    dragWithPrimary,\n    onMouseMove,\n    onMouseDown,\n    onMouseUp,\n  })\n\n\n\n  const projectRegionBox = useProjectRegionBox({ layoutParams, mat })\n\n  const [imageDimensions, changeImageDimensions] = useState()\n  const imageLoaded = Boolean(imageDimensions && imageDimensions.naturalWidth)\n\n  const ImageLoaded = useEventCallback(\n    ({ naturalWidth, naturalHeight}) => {\n      const dims = { naturalWidth, naturalHeight}\n      if (onLoaded) onLoaded(dims)\n      changeImageDimensions(dims)\n\n    }\n  )\n  const canvas = canvasEl.current\n  if (canvas && imageLoaded) {\n    const { clientWidth, clientHeight } = canvas\n\n    const fitScale = Math.max(\n      imageDimensions.naturalWidth / (clientWidth - 20),\n      imageDimensions.naturalHeight / (clientHeight - 20)\n    )\n\n    const [iw, ih] = [\n      imageDimensions.naturalWidth / fitScale,\n      imageDimensions.naturalHeight / fitScale,\n    ]\n\n    layoutParams.current = {\n      iw,\n      ih,\n      fitScale,\n      canvasWidth: clientWidth,\n      canvasHeight: clientHeight,\n    }\n  }\n\n  useEffect(() => {\n    if (!imageLoaded) return\n    changeMat(\n        getCanvasDimension(\n        zoomOnAllowedArea ? allowedArea : null,\n        layoutParams.current\n      )\n    )\n  }, [imageLoaded])\n\n  useLayoutEffect(() => {\n    if (!imageDimensions) return\n    const { clientWidth, clientHeight } = canvas\n    canvas.width = clientWidth\n    canvas.height = clientHeight\n    const context = canvas.getContext(\"2d\")\n\n    context.save()\n    context.transform(...mat.clone().inverse().toArray())\n\n    const { iw, ih } = layoutParams.current\n\n    if (allowedArea) {\n      // Pattern to indicate the NOT allowed areas\n      const { x, y, w, h } = allowedArea\n      context.save()\n      context.globalAlpha = 1\n      const outer = [\n        [0, 0],\n        [iw, 0],\n        [iw, ih],\n        [0, ih],\n      ]\n      const inner = [\n        [x * iw, y * ih],\n        [x * iw + w * iw, y * ih],\n        [x * iw + w * iw, y * ih + h * ih],\n        [x * iw, y * ih + h * ih],\n      ]\n      context.moveTo(...outer[0])\n      outer.forEach((p) => context.lineTo(...p))\n      context.lineTo(...outer[0])\n      context.closePath()\n\n      inner.reverse()\n      context.moveTo(...inner[0])\n      inner.forEach((p) => context.lineTo(...p))\n      context.lineTo(...inner[0])\n\n      context.fill()\n\n      context.restore()\n    }\n\n    context.restore()\n  })\n\n  const { iw, ih } = layoutParams.current\n\n  let zoomBox =\n    !zoomStart || !zoomEnd\n      ? null\n      : {\n          ...mat.clone().inverse().applyToPoint(zoomStart.x, zoomStart.y),\n          w: (zoomEnd.x - zoomStart.x) / mat.a,\n          h: (zoomEnd.y - zoomStart.y) / mat.d,\n        }\n  if (zoomBox) {\n    if (zoomBox.w < 0) {\n      zoomBox.x += zoomBox.w\n      zoomBox.w *= -1\n    }\n    if (zoomBox.h < 0) {\n      zoomBox.y += zoomBox.h\n      zoomBox.h *= -1\n    }\n  }\n\n  const imagePosition = {\n    topLeft: mat.clone().inverse().applyToPoint(0, 0),\n    bottomRight: mat.clone().inverse().applyToPoint(iw, ih),\n  }\n\n\n  return (\n    <div\n      style={{\n        width: \"100%\",\n        height: \"100%\",\n        maxHeight: \"calc(100vh - 68px)\",\n        position: \"relative\",\n        overflow: \"hidden\",\n        cursor: createWithPrimary\n          ? \"crosshair\"\n          : dragging\n          ? \"grabbing\"\n          : dragWithPrimary\n          ? \"grab\"\n          : zoomWithPrimary\n          ? mat.a < 1\n            ? \"zoom-out\"\n            : \"zoom-in\"\n          : undefined,\n      }}\n    >\n      {imageLoaded && !dragging && (\n        <RegionSelectAndTransformBoxes\n          key=\"regionSelectAndTransformBoxes\"\n          regions={\n             !allowedArea\n              ? regions\n              : [\n                  {\n                    type: \"rectangle\",\n                    id: \"$$allowed_area\",\n                    cls: \"allowed_area\",\n                    highlighted: true,\n                    x: allowedArea.x,\n                    y: allowedArea.y,\n                    w: allowedArea.w,\n                    h: allowedArea.h,\n                    visible: true,\n                    color: \"#ff0\",\n                  },\n                ]\n          }\n          mouseEvents={mouseEvents}\n          projectRegionBox={projectRegionBox}\n          dragWithPrimary={dragWithPrimary}\n          createWithPrimary={createWithPrimary}\n          zoomWithPrimary={zoomWithPrimary}\n          onBeginMovePoint={onBeginMovePoint}\n          onSelectRegion={onSelectRegion}\n          layoutParams={layoutParams}\n          mat={mat}\n          onBeginBoxTransform={onBeginBoxTransform}\n          onBeginMovePolygonPoint={onBeginMovePolygonPoint}\n          onBeginMoveKeypoint={onBeginMoveKeypoint}\n          onAddPolygonPoint={onAddPolygonPoint}\n        />\n      )}\n      {imageLoaded  && !dragging && (\n        <div key=\"regionTags\">\n          <RegionTags\n            regions={regions}\n            projectRegionBox={projectRegionBox}\n            mouseEvents={mouseEvents}\n            regionTagList={regionTagList}\n            onBeginRegionEdit={onBeginRegionEdit}\n            onChangeRegion={onChangeRegion}\n            onCloseRegionEdit={onCloseRegionEdit}\n            onDeleteRegion={onDeleteRegion}\n            layoutParams={layoutParams}\n            imageSrc={imageSrc}\n            onRegionClassAdded={onRegionClassAdded}\n            allowComments={allowComments}\n          />\n       </div>\n      )}\n\n      {zoomWithPrimary && zoomBox !== null && (\n        <div\n          key=\"zoomBox\"\n          style={{\n            position: \"absolute\",\n            zIndex: 1,\n            border: \"1px solid #fff\",\n            pointerEvents: \"none\",\n            left: zoomBox.x,\n            top: zoomBox.y,\n            width: zoomBox.w,\n            height: zoomBox.h,\n          }}\n        />\n      )}\n\n      <div\n        style={{ width: \"100%\", height: \"100%\" }}\n        {...mouseEvents}\n      >\n\n        <>\n          <canvas\n            style={{ opacity: 0.25 }}\n            className={classes.canvas}\n            ref={canvasEl}\n          />\n          <RegionShapes\n            imagePosition={imagePosition}\n            regions={regions}\n          />\n          <ImageCanvasBackground\n            imagePosition={imagePosition}\n            mouseEvents={mouseEvents}\n            onLoad={ImageLoaded}\n            imageSrc={imageSrc}\n          />\n        </>\n      </div>\n      <div className={classes.zoomIndicator}>\n        {((1 / mat.a) * 100).toFixed(0)}%\n      </div>\n    </div>\n  )\n}\n\nexport default ImageCanvas\n"]},"metadata":{},"sourceType":"module"}